# E2E builds spawn, then uses it and performs validations against it.
name: "E2E"

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: 1.21.9
  JQ_VERSION: '1.7'
  JQ_FORCE: false

# TODO: add back in ICS, also add other Validations from the GH issue

jobs:
  build-spawn:
    runs-on: ubuntu-latest
    name: Build Spawn
    steps:
      - uses: actions/checkout@v4

      - id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"

      - name: Setup go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      # Cache go build cache, used to speedup go test
      - name: Go Build Cache
        uses: actions/cache@v2
        with:
          path: ${{ steps.go-cache-paths.outputs.go-build }}
          key: ${{ runner.os }}-go-build-${{ hashFiles('**/go.sum') }}

      - name: Build Spawn
        run: make build

      - uses: actions/upload-artifact@master
        with:
          name: spawn
          path: ./bin/spawn

  normal-staking:
    needs: build-spawn
    uses: ./.github/workflows/reusable-e2e.yaml
    with:
      id: Normal Staking
      spawn-create-cmd: ./spawn new mychain --bypass-prompt --bech32=roll --bin=appd --no-git --org=rollchains-org --denom=uroll --debug --disable=ics
      start-chain-cmd: HOME_DIR="~/.simapp" CHAIN_ID="local-1" BLOCK_TIME="2000ms" CLEAN=true sh scripts/test_node.sh &

  normal-ics:
    needs: build-spawn
    uses: ./.github/workflows/reusable-e2e.yaml
    with:
      id: ICS
      spawn-create-cmd: ./spawn new mychain --bin=appd --bypass-prompt --bech32=roll --no-git --org=rollchains-org --denom=uroll --debug
      start-chain-cmd: HOME_DIR="~/.icsnetwork" CHAIN_ID="local-2" CLEAN=true BLOCK_TIME="500ms" sh scripts/test_ics_node.sh &